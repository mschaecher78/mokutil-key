#!/bin/bash

# mokutil-key home <https://www.github.com/mschaecher78/mokutil-key/>
# Copyright (C) 2020 <Michael L. Schaecher> GPL v2

set -e

DIR="/home/$(users)/.mok"	# Default directory is required.

VERSION="version 0.9.1.18"	# Version

# Display these helpful options.
USAGE="mokutil-key ${VERSION} (mokutil)
Usage: mokutil-key [Options]
       mokutil-key [options] [key options]=arg ... [path options]=arg

Options:
    -a,   --modules-all                  Sign all kernel mdoules.
    -m,   --module                       Sign single kernel module.
    -i,   --image                        Sign kernel/bootload binary image.
    -c,   --configure                    Configure openssl.cnf file used be openssl to create private/public key pair.
    -g,   --generate-keys                Create key pairs, when used with --set-rsa and --use-file-name for custom key
                                         size and name.
    -r,   --register-key                 Registers the key into MOK (Machine Owner Key) Management.
    -h,   --help                         displays these helpful options.
    -v,   --version                      Display mokutil-key version number.

Key Options:
          --key-private=PRIVATE_KEY      Set the pirvate key to use to for sign file/image.
          --key-public=PUBLIC_KEY        Set corresponding public key. If these options are omitted then then the default
                                         keys generated with mokutil-key will be used.

Directory/Path Options:
          --path=PATH                    This option is used for the path the the lib/module/\"kernel version\" path.

Optional:
    -n,   --use-file-name=NAME           file name for the keys, default is MOK if option is omitted.
    -s,   --set-rsa-szie=SIZE            Set the bit size of the the key pair between 2048 - 16384. The default size is
                                         2048 bits.
          --openssl-config=FILE          Use different configuration file to generate the keys.

mokutil-key home <https://www.github.com/mschaecher78/mokutil-key/>
Copyright (C) 2020 <Michael L. Schaecher> GPL v2"

# getopt
GETOPT=$(getopt -n mokutil-key -o 'a,m,i,c,g,r,h,v,n:,s:x:' -l 'modules-all,module,image,configure,generate-keys' \
	-l 'register-key,help,version,key-private:,key-public:,path:,file-name:,rsa-size:,openssl-config:expire:' \
	-- $@)

eval set -- "${GETOPT}"

# Root access is required for most options.
if [ ! "${EUID}" == "0" ] ; then

	# Check if the help/version option is used and if so exit cleanly
	if [ "${1}" == "--help" ] || [ "${1}" == "-h" ] ; then
		echo "${USAGE}"
		exit 0
	elif [ "${1}" == "--version" ] || [ "${1}" == "-v" ]; then
		echo "mokutil-key: ${VERSION}"
		exit 0
	else
		echo "mokutil-key requires root access"
		exit 1
	fi

elif [ ! "${EUID}" == "1" ] ; then

	# If the directory doesn't exist, then create it.
	if [ ! -d ${DIR} ] ; then
		mkdir -p ${DIR}
	fi

	while true  ; do

		case "${1}" in

			# Options
			-a|--modules-all) command="modall" ;;
			-m|--module) command="modone" ;;
			-i|--image) command="binary" ;;
			-c|--configure) command="config" ;;
			-g|--generate-keys) command="genkey" ;;
			-r|--register-key) command="regkey" ;;
			# Just in case root was used.
			-h|--help)	echo "${USAGE}" ;;
			-v|--version) echo "mokutil-key: ${VERSION}" ;;
			# Key Options
			--key-private)
				export PRIVATE=$(echo ${2} | awk -F'=' '{print $1}')

				# Assume that the file is the private key. If it is
				# not then sign fo file well fail.

				# Only test for file existants.
				if [ ! -f ${PRIVATE} ] ; then
					echo "Error: ${PRIVATE} does not seem to exist!"
					exit 1
				fi

				shift
			;;
			--key-public)
				export PUBLIC=$(echo ${2} | awk -F'=' '{print $1}')

				# Only test for file existants.
				if [ ! -f ${PUBLIC} ] ; then
					echo "Error: ${PUBLIC} does not seem to exist!"
					exit 1
				fi

				shift
			;;
			--path)
				export DIR_PATH=$(echo ${2} | awk -F'=' '{print $1}')
				shift
			;;
			# These options are optional.
			-n|--file-name)
				export NAME=$(echo ${2} | awk -F'=' '{print $1}')
				shift
			;;
			-s|--rsa-size)
				export SIZE=$(echo ${2} | awk -F'=' '{print $1}')

				if [[ ${SIZE} =~ [a-zA-Z] ]] ; then
					echo "Error: '${SIZE}' not a valid integer"
					exit 1
				elif [[ ${SIZE} =~ [1-9] ]] ; then

					if [ "${SIZE}" -lt "2048" ] || [ "${SIZE}" -gt "16384" ]; then
						echo "Error: '${SIZE}' invalid RSA size (2048 - 16384)!"
						exit 1
					fi

				fi

				shift
			;;
			-x|--expire)
				export EXPIRE=$(echo ${2} | awk -F'=' '{print $1}')

				if [[ ${EXPIRE} =~ [a-zA-Z] ]] ; then
					echo "Error: '${EXPIRE}' not a valid integer"
					exit 1
				elif [[ ${EXPIRE} =~ [1-9] ]] ; then

					if [ "${EXPIRE}" -lt "365" ] ; then
						echo "Warning: '${EXPIRE}' less a year is not recommended!"
						sleep 2
					fi

				fi

				shift
			;;
			--openssl-config)
				export CONFIG=$(echo ${2} | awk -F'=' '{print $2}')
				shift
			;;
			--) shift ; break ;;
		esac
		shift

	done
fi

# Set the variables even if the command is not being use, this well
# help to make the script consistent.
if [ ! "${NAME}" ] ; then
	export NAME="${DIR}/MOK"
else
	export NAME="${DIR}/${NAME}"
fi

if [ ! "${SIZE}" ] ; then
	export SIZE="2048"
fi

if [ ! "${CONFIG}" ] ; then
	export CONFIG="${DIR}/openssl.cnf"
fi

if [ ! "${EXPIRE}" ] ; then
	export EXPIRE="36500"
fi

if [ ! "${PRIVATE}" ] ; then
	export PRIVATE="/home/$(users)/.mok/MOK.priv"
fi

# If no public key entered make sure that the right default is used
# for the right object being signed.
if [ ! "${PUBLIC}" ] ; then
	export PUBLIC_PEM="${DIR}/MOK.pem"
	export PUBLIC_DER="${DIR}/MOK.der"
fi

# Which command options was give.
if [ "${command}" == "genkey" ] ; then

	# Use condistion for command.
	if ! openssl req -config ${CONFIG} -new \
	-x509 -newkey rsa:2048 -nodes -days ${EXPIRE} \
	-outform DER -keyout "${NAME}.priv" -out \
	"${NAME}.der" 2> /dev/null ; then
		echo "Error: unable to creating ${NAME}.priv key"
		echo "Error; unable to creating ${NAME}.der key"
		exit 1
	else
		echo "Created:  ${NAME}.priv"
		echo "Created:  ${NAME}.der"

		if ! openssl x509 -in ${NAME}.der -inform DER \
		-outform PEM -out ${NAME}.pem 2> /dev/null ; then
			echo "Error; unable to creating ${NAME}.pem key"
			exit 1
		else
			echo "Created:  ${NAME}.pem"

		fi

	fi

elif [ "${command}" == "modone" ] || [ "${command}" == "modall" ] ; then

	if [ ! "${PUBLIC}" ] ; then
		export PUBLIC=${PUBLIC_DER}
	fi

	# Which command option for module signing was used
	if [ "${command}" == "modone" ] ; then

		if [ ! -d ${DIR_PATH} ] ; then
			echo "Error: directory ${DIR_PATH} does not exist."
			exit 1
		else

			# Sign that sigle module.
			if ! kmodsign sha512 ${PRIVATE} ${PUBLIC} ${DIR_PATH} 2> /dev/null ; then
				echo "Error: signing ${DIR_PATH} failed!"
				exit 1
			else
				echo "Signed: ${DIR_PATH}"
			fi

		fi

	elif [ "${command}" == "modall" ] ; then

		echo "${DIR_PATH}"

		if [ -d ${DIR_PATH} ] ; then

			for modules in $(find ${DIR_PATH}/ -name *.ko -printf '%P\n') ; do

				# Sign every module.
				if ! kmodsign sha512 ${PRIVATE} ${PUBLIC} ${DIR_PATH}/${modules} 2> /dev/null ; then
					echo "Error: signing ${DIR_PATH} failed!"
					exit 1
				else
					echo "Signed: ${DIR_PATH}/${modules}"
				fi

			done

		fi

	fi

elif [ "${command}" == "binary" ] ; then

	if [ ! "${PUBLIC}" ] ; then
		export PUBLIC=${PUBLIC_PEM}
	fi

	if ! sbsign --key ${PRIVATE} --cert ${PUBLIC} ${DIR_PATH} --output ${DIR_PATH}.signed 2> /dev/null ; then
		echo "Error: failed signing ${DIR_PATH}"
		exit 1
	else
		mv -f ${DIR_PATH}.signed ${DIR_PATH}
		echo "Signed: ${DIR_PATH}"
	fi

elif [ "${command}" == "regkey" ] ; then

	if [ ! "${PUBLIC}" ] ; then
		export PUBLIC=${PUBLIC_DER}
	fi

	if ! mokutil --import ${PUBLIC} ; then
		echo "Error: Failed to register ${PUBLIC} in MOK!"
	fi

elif [ "${command}" == "config" ] ; then

	read -p "Country Code (i.e. United States = US): " COUNTRY
	read -p "State/Province Name: " PROVINCE
	read -p "locality/City Name: " LOCALITY
	read -p "Organization Name (default = ): " ORGANIZATION
	read -p "Common Name (default Signing Key): " COMMON
	read -p "Email (default = $(users)@$(hostname)): " EMAIL

	if [ ! "${ORGANIZATION}" ] || [ "${ORGANIZATION}" == "none" ] ; then
		ORGANIZATION="none"
	fi

	if [ ! "${COMMON}" ] || [ "${COMMON}" == " Signing Key" ] ; then
		COMMON="Signing Key"
	fi

	if [ ! "${EMAIL}" ] || [ "${EMAIL}" == "none" ] ; then
		EMAIL="$(hostname)@$(users)"
	fi

# Default openssl.cnf for mokutil-key.
cat <<EOF > ${DIR}/openssl.cnf
# This definition stops the following lines choking if HOME isn't
# defined.
HOME                    = .
RANDFILE                = \$ENV::HOME/.rnd

[ req ]
distinguished_name      = req_distinguished_name
x509_extensions         = v3
string_mask             = utf8only
prompt                  = no

[ req_distinguished_name ]
countryName             = ${COUNTRY}
stateOrProvinceName     = ${PROVINCE}
localityName            = ${LOCALITY}
0.organizationName      = ${ORGANIZATION}
commonName              = ${COMMON}
emailAddress            = ${EMAIL}

[ v3 ]
subjectKeyIdentifier    = hash
authorityKeyIdentifier  = keyid:always,issuer
basicConstraints        = critical,CA:FALSE
extendedKeyUsage        = codeSigning,1.3.6.1.4.1.311.10.3.6,1.3.6.1.4.1.2312.16.1.2
nsComment               = "OpenSSL Generated Certificate"
EOF

fi
